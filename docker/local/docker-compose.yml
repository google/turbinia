version: "3.2"
services:
    dind:
        image: docker:24.0.5-dind
        hostname: dind
        privileged: true
        expose:
            - 2376
        healthcheck:
            test: docker ps
        volumes:
            - $PWD/certs:/certs
            - $PWD/evidence:/evidence
            - $PWD/tmp:/tmp # change this to match the TMP_DIR folder in turbinia.conf

    redis:
        image: "redis:alpine"

        command: redis-server
        # This will *only* expose it to the docker network, not to the host.
        # See https://docs.docker.com/compose/compose-file/compose-file-v3/#expose
        expose:
            - "6379"

        volumes:
            - $PWD/redis-data:/var/lib/redis

        environment:
            - REDIS_REPLICATION_MODE=master

    turbinia-server:
        #image: "turbinia-server-dev" # Use this for local development and comment out below line
        image: "us-docker.pkg.dev/osdfir-registry/turbinia/release/turbinia-server:latest" # Latest stable
        container_name: turbinia-server

        volumes:
            - $PWD/evidence:/evidence
            - $PWD/conf/turbinia.conf:/etc/turbinia/turbinia.conf

        environment:
            - LC_ALL=C.UTF-8
            - LANG=C.UTF-8
            - TURBINIA_EXTRA_ARGS=${TURBINIA_EXTRA_ARGS}

    turbinia-api-server:
        #image: "turbinia-api-server-dev" # Use this for local development and comment out below line
        image: "us-docker.pkg.dev/osdfir-registry/turbinia/release/turbinia-api-server:latest" # Latest stable
        container_name: turbinia-api-server

        volumes:
            - $PWD/evidence:/evidence
            - $PWD/conf/turbinia.conf:/etc/turbinia/turbinia.conf

        environment:
            - LC_ALL=C.UTF-8
            - LANG=C.UTF-8
            - TURBINIA_EXTRA_ARGS=${TURBINIA_EXTRA_ARGS}

    turbinia-worker:
        #image: "turbinia-worker-dev" # Use this for local development and comment out below line
        image: "us-docker.pkg.dev/osdfir-registry/turbinia/release/turbinia-worker:latest" # Latest stable
        container_name: turbinia-worker
        privileged: true
        depends_on:
            dind:
                condition: service_healthy

        volumes:
            - $PWD/evidence:/evidence
            - $PWD/conf/turbinia.conf:/etc/turbinia/turbinia.conf
            - $PWD/certs:/certs
            - $PWD/tmp:/tmp # change this to match the TMP_DIR folder in turbinia.conf

        environment:
            - LC_ALL=C.UTF-8
            - LANG=C.UTF-8
            - TURBINIA_EXTRA_ARGS=${TURBINIA_EXTRA_ARGS}
            - DOCKER_HOST=tcp://dind:2376
            - DOCKER_TLS_VERIFY=1
            - DOCKER_CERT_PATH=/certs/client
    # Uncomment below in case you want to run a second worker on the same host.
    #  turbinia-worker2:
    #     image: "turbinia-worker-dev" # Use this for local development and comment out below line
    #     image: "us-docker.pkg.dev/osdfir-registry/turbinia/release/turbinia-worker:latest" # Latest stable
    #     container_name: turbinia-worker2
    #     privileged: true
    #       depends_on:
    #         dind:
    #             condition: service_healthy

    #     volumes:
    #      - $PWD/evidence:/evidence
    #      - $PWD/conf/turbinia.conf:/etc/turbinia/turbinia.conf
    #      - $PWD/certs:/certs


    #     environment:
    #      - LC_ALL=C.UTF-8
    #      - LANG=C.UTF-8
    #      - TURBINIA_EXTRA_ARGS=${TURBINIA_EXTRA_ARGS}
    #      - DOCKER_HOST=tcp://dind:2376
    #      - DOCKER_TLS_VERIFY=1
    #      - DOCKER_CERT_PATH=/certs/client
