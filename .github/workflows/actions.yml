name: Turbinia Test Run

on: [push, pull_request]

jobs:
  install-n-test:
    name: Install Turbinia dependencies and run tests.
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Pull latest docker image for cache
        run: |
          docker pull ubuntu:18.04
          docker pull us-docker.pkg.dev/osdfir-registry/turbinia/release/turbinia-worker-dev:latest
      - name: Build Turbinia worker docker image
        run: docker build --cache-from=ubuntu:18.04,us-docker.pkg.dev/osdfir-registry/turbinia/release/turbinia-worker-dev:latest -t turbinia-worker-dev -f docker/worker/Dockerfile .
      - name: Run test (turbinia-worker) container
        run: |
          docker run --name turbinia-worker --entrypoint "/bin/bash" -d -t turbinia-worker-dev:latest
      - name: Install test dependencies
        run: |
          docker exec -t turbinia-worker "python -m pip install --upgrade pip"
          docker exec -t turbinia-worker "pip install mock nose coverage yapf"
          docker exec -t turbinia-worker "pip install tox"
      - name: Run Tests
        run: |
          docker exec -t turbinia-worker "cd /tmp && ./run_tests.py"
          docker exec -t turbinia-worker "cd /tmo && tox --sitepackages ${TOXENV}"
