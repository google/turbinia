apiVersion: skaffold/v4beta6
kind: Config
metadata:
  name: turbinia
build:
  local:
    useDockerCLI: true
    useBuildkit: true 
    concurrency: 0
    # tryImportMissing: true
  artifacts:
    - image: turbinia-worker
      docker:
        dockerfile: docker/worker/Dockerfile
        target: turbinia-worker-dev
      sync:
        infer:
        - turbinia/**
    - image: turbinia-server
      docker:
        dockerfile: docker/server/Dockerfile
        target: turbinia-server-dev
      sync:
        infer:
        - turbinia/**
    # - image: turbinia-api
    #   docker:
    #     dockerfile: docker/api_server/Dockerfile.dev
deploy:
  statusCheckDeadlineSeconds: 30
  helm:
    releases:
    - name: dev-release
      remoteChart: oci://us-docker.pkg.dev/osdfir-registry/osdfir-charts/turbinia
      # chartPath: ./charts/turbinia
      setValues:
        # config.override: "/tmp/turbinia/conf/turbinia.conf"
        versioncheck.enabled: False
      setValueTemplates:
        worker.image.repository: "{{.IMAGE_REPO_turbinia_worker}}"
        worker.image.tag: "{{.IMAGE_TAG_turbinia_worker}}@{{.IMAGE_DIGEST_turbinia_worker}}"
        server.image.repository: "{{.IMAGE_REPO_turbinia_server}}"
        server.image.tag: "{{.IMAGE_TAG_turbinia_server}}@{{.IMAGE_DIGEST_turbinia_server}}"
        # api.image.repository: "{{.IMAGE_REPO_turbinia_api}}"
        # api.image.tag: "{{.IMAGE_TAG_turbinia_api}}@{{.IMAGE_DIGEST_turbinia_api}}"
portForward:
# - resourceType: deployment
#   resourceName: dev-release-turbinia-worker
#   port: 10000 # worker debugpy port
# - resourceType: deployment
#   resourceName: dev-release-turbinia-server
#   port: 20000 # server debugpy port
- resourceType: deployment
  resourceName: dev-release-turbinia-api
  port: 8000 # API and WebUI port
# - resourceType: deployment
#   resourceName: dev-release-turbinia-api-metrics
#   port: 9200 
# - resourceType: deployment
#   resourceName: dev-release-turbinia-worker-metrics
#   port: 9200 
# - resourceType: deployment
#   resourceName: dev-release-turbinia-server-metrics
#   port: 9200 

